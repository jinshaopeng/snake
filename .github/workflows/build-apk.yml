name: Build Snake Game APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GRADLE_OPTS: "-Xmx4g -Xms2g"
      ANDROID_HOME: /usr/local/android-sdk
      # 添加环境变量禁用配置缓存，避免Gradle 8.1的兼容性问题
      ORG_GRADLE_CONFIGURATION_CACHE: "false"

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm' # 启用npm缓存，加速依赖安装

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle' # 启用Gradle缓存，但后续会清理损坏的缓存

    - name: Install Android SDK
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: 9477386
        packages: 'platform-tools platforms;android-34 build-tools;34.0.0'

    # ========== 新增：修复Gradle缓存权限和清理损坏缓存 ==========
    - name: Fix Gradle cache permissions and clean corrupted cache
      run: |
        # 创建Gradle缓存目录并赋予正确权限
        mkdir -p /home/runner/.gradle/caches/
        chown -R runner:runner /home/runner/.gradle/
        chmod -R 755 /home/runner/.gradle/
        
        # 停止所有Gradle守护进程
        ./gradlew --stop || true
        
        # 删除损坏的JAR缓存目录（针对bcprov-jdk18on相关错误）
        rm -rf /home/runner/.gradle/caches/jars-9/ || true

    - name: Install Capacitor and dependencies
      run: |
        npm init -y
        npm install @capacitor/core @capacitor/cli @capacitor/android

    - name: Initialize Capacitor and add Android
      run: |
        npx cap init "贪吃蛇" com.example.snakegame --web-dir=www
        npx cap add android

    - name: Copy www files
      run: |
        ls -la www/

    # ========== 优化：生成完整且语法正确的 Gradle 配置（保留你的逻辑，新增BC库版本强制指定） ==========
    - name: Fix Gradle configuration files
      run: |
        # 1. 生成根目录 build.gradle（新增BC库版本强制指定）
        cat > android/build.gradle << 'EOF'
        // Top-level build file where you can add configuration options common to all sub-projects/modules.
        buildscript {
            ext {
                kotlin_version = "1.9.0"
                compileSdkVersion = 34
                minSdkVersion = 21
                targetSdkVersion = 34
                androidxActivityVersion = '1.8.0'
                androidxAppCompatVersion = '1.6.1'
                androidxCoordinatorLayoutVersion = '1.2.0'
                androidxCoreVersion = '1.12.0'
                androidxFragmentVersion = '1.6.1'
                coreSplashscreenVersion = '1.0.1'
                androidxWebkitVersion = '1.6.1'
                junitVersion = '4.13.2'
                androidxJunitVersion = '1.1.5'
                androidxEspressoCoreVersion = '3.5.1'
                cordovaAndroidVersion = '10.1.1'
            }
            repositories {
                // 国内镜像优先
                maven { url 'https://maven.aliyun.com/repository/public' }
                maven { url 'https://maven.aliyun.com/repository/google' }
                maven { url 'https://maven.aliyun.com/repository/gradle-plugin' }
                google()
                mavenCentral()
            }
            dependencies {
                classpath 'com.android.tools.build:gradle:8.1.4'
                classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version"
            }
        }

        allprojects {
            repositories {
                // 国内镜像优先
                maven { url 'https://maven.aliyun.com/repository/public' }
                maven { url 'https://maven.aliyun.com/repository/google' }
                google()
                mavenCentral()
            }
            // 新增：强制指定BC库版本，解决Jar创建失败问题
            configurations.all {
                resolutionStrategy {
                    force 'org.bouncycastle:bcprov-jdk18on:1.78.1'
                }
            }
        }

        task clean(type: Delete) {
            delete rootProject.buildDir
        }
        EOF

        # 2. 生成 app 模块 build.gradle（无修改，保留你的逻辑）
        cat > android/app/build.gradle << 'EOF'
        apply plugin: 'com.android.application'
        apply plugin: 'kotlin-android'

        android {
            namespace "com.example.snakegame"
            compileSdkVersion rootProject.ext.compileSdkVersion
            buildToolsVersion "34.0.0"

            defaultConfig {
                applicationId "com.example.snakegame"
                minSdkVersion rootProject.ext.minSdkVersion
                targetSdkVersion rootProject.ext.targetSdkVersion
                versionCode 1
                versionName "1.0"

                testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
            }

            buildTypes {
                release {
                    minifyEnabled false
                    proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                }
            }
            
            compileOptions {
                sourceCompatibility JavaVersion.VERSION_17
                targetCompatibility JavaVersion.VERSION_17
            }
            
            kotlinOptions {
                jvmTarget = JavaVersion.VERSION_17.toString()
            }
        }

        dependencies {
            implementation fileTree(dir: 'libs', include: ['*.jar'])
            implementation "org.jetbrains.kotlin:kotlin-stdlib:$kotlin_version"
            implementation "androidx.appcompat:appcompat:$androidxAppCompatVersion"
            implementation "com.google.android.material:material:1.11.0"
            implementation "androidx.activity:activity:$androidxActivityVersion"
            implementation "androidx.fragment:fragment:$androidxFragmentVersion"
            implementation "androidx.core:core-ktx:$androidxCoreVersion"
            implementation "androidx.webkit:webkit:$androidxWebkitVersion"
            
            testImplementation "junit:junit:$junitVersion"
            androidTestImplementation "androidx.test.ext:junit:$androidxJunitVersion"
            androidTestImplementation "androidx.test.espresso:espresso-core:$androidxEspressoCoreVersion"
            
            // Capacitor 核心依赖
            implementation project(':capacitor-android')
        }

        apply from: 'capacitor.build.gradle'

        try {
            def servicesJSON = file('google-services.json')
            if (servicesJSON.text) {
                apply plugin: 'com.google.gms.google-services'
            }
        } catch (Exception e) {
            logger.warn("google-services.json not found, google-services plugin not applied. Push Notification won't work")
        }
        EOF

        # 3. 配置 gradle.properties（新增禁用配置缓存）
        cat > android/gradle.properties << 'EOF'
        org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
        android.useAndroidX=true
        android.nonTransitiveRClass=true
        android.enableJetifier=true
        org.gradle.caching=false
        org.gradle.configuration-cache=false # 禁用配置缓存，避免Gradle 8.1的bug
        org.gradle.internal.http.connectionTimeout=300000
        org.gradle.internal.http.socketTimeout=300000
        # 禁用守护进程，避免CI环境中进程残留问题
        org.gradle.daemon=false
        EOF

        # 4. 配置 gradle wrapper（保留你的逻辑）
        cat > android/gradle/wrapper/gradle-wrapper.properties << 'EOF'
        distributionBase=GRADLE_USER_HOME
        distributionPath=wrapper/dists
        distributionUrl=https\://services.gradle.org/distributions/gradle-8.1-bin.zip
        zipStoreBase=GRADLE_USER_HOME
        zipStorePath=wrapper/dists
        EOF

    # ========== 优化构建命令：添加更多稳定性参数 ==========
    - name: Sync and build
      run: |
        npx cap sync android
        cd android
        chmod +x gradlew
        # 添加--no-configuration-cache和--stacktrace便于排查问题，--refresh-dependencies强制刷新依赖
        ./gradlew clean assembleDebug --refresh-dependencies --no-daemon --no-configuration-cache --stacktrace

    - name: Find APK
      run: |
        find . -name "*.apk" -type f

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: SnakeGame-APK
        path: android/app/build/outputs/apk/debug/*.apk
