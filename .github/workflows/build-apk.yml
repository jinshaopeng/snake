name: Build Snake Game APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GRADLE_OPTS: "-Xmx4g -Xms2g"
      ANDROID_HOME: /usr/local/android-sdk

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Install Android SDK
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: 9477386
        packages: 'platform-tools platforms;android-34 build-tools;34.0.0'

    - name: Install Capacitor and dependencies
      run: |
        npm init -y
        npm install @capacitor/core @capacitor/cli @capacitor/android

    - name: Initialize Capacitor and add Android
      run: |
        npx cap init "贪吃蛇" com.example.snakegame --web-dir=www
        npx cap add android

    - name: Copy www files
      run: |
        ls -la www/

    # ========== 修复：正确配置 Gradle 镜像和 Android 构建参数 ==========
    - name: Configure Gradle and Android build settings
      run: |
        # 1. 配置根目录 build.gradle（添加镜像，不覆盖原有内容）
        sed -i 's|repositories {|repositories {\n        maven { url "https://maven.aliyun.com/repository/public" }\n        maven { url "https://maven.aliyun.com/repository/google" }|g' android/build.gradle
        sed -i 's|allprojects {|allprojects {\n    repositories {\n        maven { url "https://maven.aliyun.com/repository/public" }\n        maven { url "https://maven.aliyun.com/repository/google" }|g' android/build.gradle

        # 2. 配置 app 模块的 build.gradle（添加必要的 Android 构建参数）
        cat > android/app/build.gradle << 'EOF'
        apply plugin: 'com.android.application'

        android {
            namespace "com.example.snakegame"
            compileSdkVersion 34
            buildToolsVersion "34.0.0"

            defaultConfig {
                applicationId "com.example.snakegame"
                minSdkVersion 21
                targetSdkVersion 34
                versionCode 1
                versionName "1.0"

                testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
            }

            buildTypes {
                release {
                    minifyEnabled false
                    proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                }
            }
            
            compileOptions {
                sourceCompatibility JavaVersion.VERSION_17
                targetCompatibility JavaVersion.VERSION_17
            }
        }

        dependencies {
            implementation fileTree(dir: 'libs', include: ['*.jar'])
            implementation 'androidx.appcompat:appcompat:1.6.1'
            implementation 'com.google.android.material:material:1.11.0'
            testImplementation 'junit:junit:4.13.2'
            androidTestImplementation 'androidx.test.ext:junit:1.1.5'
            androidTestImplementation 'androidx.test.espresso:espresso-core:3.5.1'
            
            // Capacitor 核心依赖
            implementation project(':capacitor-android')
        }

        apply from: 'capacitor.build.gradle'

        try {
            def servicesJSON = file('google-services.json')
            if (servicesJSON.text) {
                apply plugin: 'com.google.gms.google-services'
            }
        } catch (Exception e) {
            logger.warn("google-services.json not found, google-services plugin not applied. Push Notification won't work")
        }
        EOF

        # 3. 优化 Gradle 属性
        echo "org.gradle.caching=false" >> android/gradle.properties
        echo "org.gradle.internal.http.connectionTimeout=300000" >> android/gradle.properties
        echo "org.gradle.internal.http.socketTimeout=300000" >> android/gradle.properties
        echo "android.useAndroidX=true" >> android/gradle.properties
        echo "android.enableJetifier=true" >> android/gradle.properties

    - name: Sync and build
      run: |
        npx cap sync android
        cd android
        chmod +x gradlew
        ./gradlew clean assembleDebug --refresh-dependencies --no-daemon

    - name: Find APK
      run: |
        find . -name "*.apk" -type f

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: SnakeGame-APK
        path: android/app/build/outputs/apk/debug/*.apk
