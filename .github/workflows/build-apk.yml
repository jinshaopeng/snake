name: Build Snake Game APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GRADLE_OPTS: "-Xmx4g -Xms2g"
      ANDROID_HOME: /usr/local/android-sdk

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'

    - name: Install Android SDK
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: 9477386
        packages: 'platform-tools platforms;android-34 platforms;android-22 build-tools;34.0.0'
        cache: true

    - name: Install stable Capacitor version
      run: |
        npm init -y
        npm install @capacitor/core@4.8.1 @capacitor/cli@4.8.1 @capacitor/android@4.8.1

    - name: Initialize Capacitor and add Android
      run: |
        npx cap init "贪吃蛇" com.example.snakegame --web-dir=www
        npx cap add android

    - name: Prepare web assets
      run: |
        mkdir -p www
        cat > www/index.html << 'HTML'
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>贪吃蛇游戏</title>
    <style>
        body { margin: 0; padding: 20px; font-family: Arial; }
        #game { width: 100%; height: 400px; border: 1px solid #000; }
    </style>
</head>
<body>
    <h1>贪吃蛇游戏</h1>
    <div id="game"></div>
    <script>
        document.getElementById('game').innerText = '贪吃蛇游戏加载中...';
    </script>
</body>
</html>
HTML
        ls -la www/

    - name: Fix Gradle and resource configuration
      run: |
        # 1. 根目录build.gradle
        cat > android/build.gradle << 'EOF'
buildscript {
    ext {
        kotlin_version = "1.8.22"
        compileSdkVersion = 34
        minSdkVersion = 22
        targetSdkVersion = 34
        androidxActivityVersion = '1.6.1'
        androidxAppCompatVersion = '1.6.1'
        androidxCoordinatorLayoutVersion = '1.2.0'
        androidxCoreVersion = '1.9.0'
        androidxFragmentVersion = '1.5.7'
        coreSplashscreenVersion = '1.0.1'
        androidxWebkitVersion = '1.5.0'
        junitVersion = '4.13.2'
        androidxJunitVersion = '1.1.5'
        androidxEspressoCoreVersion = '3.5.1'
        cordovaAndroidVersion = '10.1.1'
    }
    repositories {
        maven { url 'https://maven.aliyun.com/repository/public' }
        maven { url 'https://maven.aliyun.com/repository/google' }
        maven { url 'https://maven.aliyun.com/repository/gradle-plugin' }
        google()
        mavenCentral()
    }
    dependencies {
        classpath 'com.android.tools.build:gradle:8.0.0'
        classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version"
    }
}

allprojects {
    repositories {
        maven { url 'https://maven.aliyun.com/repository/public' }
        maven { url 'https://maven.aliyun.com/repository/google' }
        google()
        mavenCentral()
    }
}

task clean(type: Delete) {
    delete rootProject.buildDir
}
EOF

        # 2. app模块build.gradle
        cat > android/app/build.gradle << 'EOF'
apply plugin: 'com.android.application'
apply plugin: 'kotlin-android'

android {
    namespace "com.example.snakegame"
    compileSdkVersion rootProject.ext.compileSdkVersion
    buildToolsVersion "34.0.0"

    defaultConfig {
        applicationId "com.example.snakegame"
        minSdkVersion rootProject.ext.minSdkVersion
        targetSdkVersion rootProject.ext.targetSdkVersion
        versionCode 1
        versionName "1.0"

        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
    }

    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
    }
    
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_17
        targetCompatibility JavaVersion.VERSION_17
    }
    
    kotlinOptions {
        jvmTarget = JavaVersion.VERSION_17.toString()
    }
    
    namespace 'com.example.snakegame'
}

dependencies {
    implementation fileTree(dir: 'libs', include: ['*.jar'])
    implementation "org.jetbrains.kotlin:kotlin-stdlib:$kotlin_version"
    implementation "androidx.appcompat:appcompat:$androidxAppCompatVersion"
    implementation "com.google.android.material:material:1.9.0"
    implementation "androidx.activity:activity:$androidxActivityVersion"
    implementation "androidx.fragment:fragment:$androidxFragmentVersion"
    implementation "androidx.core:core-ktx:$androidxCoreVersion"
    implementation "androidx.webkit:webkit:$androidxWebkitVersion"
    
    testImplementation "junit:junit:$junitVersion"
    androidTestImplementation "androidx.test.ext:junit:$androidxJunitVersion"
    androidTestImplementation "androidx.test.espresso:espresso-core:$androidxEspressoCoreVersion"
    
    implementation project(':capacitor-android')
}

apply from: 'capacitor.build.gradle'

try {
    def servicesJSON = file('google-services.json')
    if (servicesJSON.text) {
        apply plugin: 'com.google.gms.google-services'
    }
} catch (Exception e) {
    logger.warn("google-services.json not found, google-services plugin not applied")
}
EOF

        # 3. gradle.properties
        cat > android/gradle.properties << 'EOF'
org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
android.useAndroidX=true
android.nonTransitiveRClass=true
android.enableJetifier=true
org.gradle.caching=true
org.gradle.parallel=true
EOF

        # 4. gradle-wrapper.properties
        cat > android/gradle/wrapper/gradle-wrapper.properties << 'EOF'
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-8.0-bin.zip
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
EOF

        # 5. styles.xml
        mkdir -p android/app/src/main/res/values
        cat > android/app/src/main/res/values/styles.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <style name="AppTheme" parent="Theme.MaterialComponents.Light.NoActionBar">
        <item name="colorPrimary">@android:color/white</item>
        <item name="colorPrimaryDark">@android:color/white</item>
        <item name="colorAccent">@android:color/black</item>
        <item name="android:windowBackground">@android:color/white</item>
    </style>
</resources>
EOF

        # 6. AndroidManifest.xml
        mkdir -p android/app/src/main
        cat > android/app/src/main/AndroidManifest.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.example.snakegame">

    <application
        android:allowBackup="true"
        android:icon="@mipmap/ic_launcher"
        android:label="贪吃蛇"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:theme="@style/AppTheme">
        <activity
            android:name="com.getcapacitor.BridgeActivity"
            android:configChanges="orientation|keyboardHidden|keyboard|screenSize|locale|smallestScreenSize|screenLayout|uiMode"
            android:exported="true"
            android:label="@string/app_name"
            android:launchMode="singleTask"
            android:theme="@style/AppTheme">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
        <provider
            android:name="androidx.core.content.FileProvider"
            android:authorities="${applicationId}.fileprovider"
            android:exported="false"
            android:grantUriPermissions="true">
            <meta-data
                android:name="android.support.FILE_PROVIDER_PATHS"
                android:resource="@xml/file_paths" />
        </provider>
    </application>
</manifest>
EOF

        # 7. file_paths.xml
        mkdir -p android/app/src/main/res/xml
        cat > android/app/src/main/res/xml/file_paths.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<paths xmlns:android="http://schemas.android.com/apk/res/android">
    <external-files-path name="external_files" path="." />
    <files-path name="files" path="." />
</paths>
EOF

    - name: Clean and build
      run: |
        rm -rf ~/.gradle/caches/
        rm -rf android/.gradle/
        rm -rf android/app/build/
        
        npx cap sync android
        
        cd android
        chmod +x gradlew
        ./gradlew clean assembleDebug --refresh-dependencies --no-daemon \
          -Dorg.gradle.logging.level=info \
          -Dandroid.debug.obsoleteApi=true

    - name: Verify APK
      run: |
        find . -name "*.apk" -type f -ls
        if [ -f "android/app/build/outputs/apk/debug/app-debug.apk" ]; then
            echo "APK构建成功！"
            ls -la android/app/build/outputs/apk/debug/
        else
            echo "APK构建失败！"
            exit 1
        fi

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: SnakeGame-APK
        path: android/app/build/outputs/apk/debug/*.apk
        retention-days: 30
