name: Build Snake Game APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GRADLE_OPTS: "-Xmx4g -Xms2g"
      ANDROID_HOME: /usr/local/android-sdk

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Install Android SDK
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: 9477386
        # 确保安装Android 22+的SDK（适配minSdkVersion 22）
        packages: 'platform-tools platforms;android-34 platforms;android-22 build-tools;34.0.0'

    - name: Install Capacitor and dependencies
      run: |
        npm init -y
        npm install @capacitor/core @capacitor/cli @capacitor/android

    - name: Initialize Capacitor and add Android
      run: |
        npx cap init "贪吃蛇" com.example.snakegame --web-dir=www
        npx cap add android

    - name: Copy www files
      run: |
        # 确保www目录存在（如果为空，创建空文件避免Capacitor报错）
        mkdir -p www
        echo "<html><body>Snake Game</body></html>" > www/index.html
        ls -la www/

    - name: Fix Gradle configuration for JDK 21
      run: |
        # 1. 根目录build.gradle（minSdkVersion升级到22）
        cat > android/build.gradle << 'EOF'
        buildscript {
            ext {
                kotlin_version = "1.9.20"
                compileSdkVersion = 34
                minSdkVersion = 22  // 关键：升级到22，匹配Cordova要求
                targetSdkVersion = 34
                androidxActivityVersion = '1.8.0'
                androidxAppCompatVersion = '1.6.1'
                androidxCoordinatorLayoutVersion = '1.2.0'
                androidxCoreVersion = '1.12.0'
                androidxFragmentVersion = '1.6.1'
                coreSplashscreenVersion = '1.0.1'
                androidxWebkitVersion = '1.6.1'
                junitVersion = '4.13.2'
                androidxJunitVersion = '1.1.5'
                androidxEspressoCoreVersion = '3.5.1'
                cordovaAndroidVersion = '10.1.1'
            }
            repositories {
                maven { url 'https://maven.aliyun.com/repository/public' }
                maven { url 'https://maven.aliyun.com/repository/google' }
                maven { url 'https://maven.aliyun.com/repository/gradle-plugin' }
                google()
                mavenCentral()
            }
            dependencies {
                classpath 'com.android.tools.build:gradle:8.4.0'
                classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version"
            }
        }

        allprojects {
            repositories {
                maven { url 'https://maven.aliyun.com/repository/public' }
                maven { url 'https://maven.aliyun.com/repository/google' }
                google()
                mavenCentral()
            }
        }

        task clean(type: Delete) {
            delete rootProject.buildDir
        }
        EOF

        # 2. app模块build.gradle（同步minSdkVersion到22）
        cat > android/app/build.gradle << 'EOF'
        apply plugin: 'com.android.application'
        apply plugin: 'kotlin-android'

        android {
            namespace "com.example.snakegame"
            compileSdkVersion rootProject.ext.compileSdkVersion
            buildToolsVersion "34.0.0"

            defaultConfig {
                applicationId "com.example.snakegame"
                minSdkVersion rootProject.ext.minSdkVersion  // 继承22
                targetSdkVersion rootProject.ext.targetSdkVersion
                versionCode 1
                versionName "1.0"

                testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
            }

            buildTypes {
                release {
                    minifyEnabled false
                    proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                }
            }
            
            compileOptions {
                sourceCompatibility JavaVersion.VERSION_21
                targetCompatibility JavaVersion.VERSION_21
            }
            
            kotlinOptions {
                jvmTarget = JavaVersion.VERSION_21.toString()
            }
        }

        dependencies {
            implementation fileTree(dir: 'libs', include: ['*.jar'])
            implementation "org.jetbrains.kotlin:kotlin-stdlib:$kotlin_version"
            implementation "androidx.appcompat:appcompat:$androidxAppCompatVersion"
            implementation "com.google.android.material:material:1.11.0"
            implementation "androidx.activity:activity:$androidxActivityVersion"
            implementation "androidx.fragment:fragment:$androidxFragmentVersion"
            implementation "androidx.core:core-ktx:$androidxCoreVersion"
            implementation "androidx.webkit:webkit:$androidxWebkitVersion"
            
            testImplementation "junit:junit:$junitVersion"
            androidTestImplementation "androidx.test.ext:junit:$androidxJunitVersion"
            androidTestImplementation "androidx.test.espresso:espresso-core:$androidxEspressoCoreVersion"
            
            implementation project(':capacitor-android')
        }

        apply from: 'capacitor.build.gradle'

        try {
            def servicesJSON = file('google-services.json')
            if (servicesJSON.text) {
                apply plugin: 'com.google.gms.google-services'
            }
        } catch (Exception e) {
            logger.warn("google-services.json not found, google-services plugin not applied")
        }
        EOF

        # 3. gradle.properties
        cat > android/gradle.properties << 'EOF'
        org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
        android.useAndroidX=true
        android.nonTransitiveRClass=true
        android.enableJetifier=true
        org.gradle.caching=false
        org.gradle.internal.http.connectionTimeout=300000
        org.gradle.internal.http.socketTimeout=300000
        org.gradle.classpath.instrumentation.enabled=false
        EOF

        # 4. Gradle 8.6（适配AGP 8.4.0）
        cat > android/gradle/wrapper/gradle-wrapper.properties << 'EOF'
        distributionBase=GRADLE_USER_HOME
        distributionPath=wrapper/dists
        distributionUrl=https\://services.gradle.org/distributions/gradle-8.6-bin.zip
        zipStoreBase=GRADLE_USER_HOME
        zipStorePath=wrapper/dists
        EOF

    - name: Clean Gradle cache and build
      run: |
        rm -rf ~/.gradle/caches/
        npx cap sync android
        cd android
        chmod +x gradlew
        ./gradlew clean assembleDebug --refresh-dependencies --no-daemon --no-build-cache

    - name: Find APK
      run: |
        find . -name "*.apk" -type f

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: SnakeGame-APK
        path: android/app/build/outputs/apk/debug/*.apk
