name: Build Snake Game APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    # 增加 Gradle 内存配置，避免构建内存不足
    env:
      GRADLE_OPTS: "-Xmx4g -Xms2g"
      ANDROID_HOME: /usr/local/android-sdk

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Install Android SDK
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: 9477386
        packages: 'platform-tools platforms;android-34 build-tools;34.0.0'

    - name: Install Capacitor and dependencies
      run: |
        npm init -y
        npm install @capacitor/core @capacitor/cli @capacitor/android

    - name: Initialize Capacitor and add Android
      run: |
        npx cap init "贪吃蛇" com.example.snakegame --web-dir=www
        npx cap add android

    - name: Copy www files
      run: |
        ls -la www/

    # ========== 新增关键步骤：配置 Gradle 国内镜像 ==========
    - name: Configure Gradle with China mirror
      run: |
        # 1. 修改 android/build.gradle 添加阿里云 Maven 镜像
        cat > android/build.gradle << 'EOF'
        buildscript {
            repositories {
                maven { url 'https://maven.aliyun.com/repository/public' }
                maven { url 'https://maven.aliyun.com/repository/google' }
                google()
                mavenCentral()
            }
            dependencies {
                classpath 'com.android.tools.build:gradle:8.1.4'
            }
        }

        allprojects {
            repositories {
                maven { url 'https://maven.aliyun.com/repository/public' }
                maven { url 'https://maven.aliyun.com/repository/google' }
                google()
                mavenCentral()
            }
        }

        task clean(type: Delete) {
            delete rootProject.buildDir
        }
        EOF

        # 2. 禁用 Gradle 缓存，避免缓存损坏问题
        echo "org.gradle.caching=false" >> android/gradle.properties
        # 3. 增加 Gradle 超时时间
        echo "org.gradle.internal.http.connectionTimeout=300000" >> android/gradle.properties
        echo "org.gradle.internal.http.socketTimeout=300000" >> android/gradle.properties

    - name: Sync and build
      run: |
        npx cap sync android
        cd android
        chmod +x gradlew
        # 关键修改：添加 --refresh-dependencies 强制刷新依赖，--no-daemon 避免守护进程问题
        ./gradlew clean assembleDebug --refresh-dependencies --no-daemon

    - name: Find APK
      run: |
        find . -name "*.apk" -type f

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: SnakeGame-APK
        path: android/app/build/outputs/apk/debug/*.apk
